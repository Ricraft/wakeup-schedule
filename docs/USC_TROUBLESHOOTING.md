# 南华大学教务系统导入 - 故障排除指南

## 常见问题及解决方案

### 问题 1: HTTP 403 Forbidden 错误

**症状**: 访问课表页面时显示 403 错误

**原因**:
1. 登录会话已过期或未登录
2. 直接访问课表 URL 而没有通过正常流程
3. 服务器检测到异常访问模式

**解决方案**:

#### 方案 A: 正确的登录流程 ✅
```
1. 在 WebView 中打开教务系统首页
2. 手动输入学号和密码
3. 点击登录按钮（不要按回车）
4. 登录成功后，在页面内点击"课表查询"等链接
5. 等待课表页面完全加载
6. 点击"获取课表"按钮
```

#### 方案 B: 避免直接访问 URL ❌
```
错误做法：
- 直接在地址栏输入课表详情 URL
- 复制粘贴课表链接
- 使用书签直接跳转

正确做法：
- 从登录页开始
- 通过页面内的链接导航
- 保持会话连续性
```

### 问题 2: 页面加载不完整

**症状**: 点击"获取课表"后提示"未找到课程"

**原因**:
1. 页面尚未完全加载
2. 课表数据通过 AJAX 异步加载
3. iframe 内容未加载完成

**解决方案**:

#### 等待加载完成
```
1. 观察底部状态栏
2. 等待显示"✓ 页面加载完成"
3. 确认课表内容可见
4. 再点击"获取课表"按钮
```

#### 检查加载进度
```
- 加载中... 50% → 等待
- 加载中... 100% → 等待
- ✓ 页面加载完成 → 可以获取
- ✓ 就绪 → 可以获取
```

### 问题 3: 登录状态检测

**症状**: 提示"需要登录"或"检测到登录页面"

**原因**:
1. 未登录或登录失败
2. 会话超时
3. Cookie 被清除

**解决方案**:

#### 重新登录
```
1. 点击"刷新"按钮
2. 重新输入学号密码
3. 确认登录成功（页面跳转）
4. 导航到课表页面
```

#### 检查登录状态
```
登录成功的标志：
- 页面显示学生姓名
- 可以看到个人信息
- 菜单栏显示"退出"选项
```

### 问题 4: User-Agent 被拦截

**症状**: 页面显示"不支持的浏览器"或直接 403

**原因**:
服务器检测到非标准浏览器

**解决方案**:
已在代码中设置标准 Chrome User-Agent:
```python
profile.setHttpUserAgent(
    "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 "
    "(KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
)
```

### 问题 5: iframe 内容无法访问

**症状**: 提取的 HTML 为空或不完整

**原因**:
1. iframe 跨域限制
2. iframe 未加载完成
3. JavaScript 执行时机不对

**解决方案**:

#### 改进的 JavaScript 代码
```javascript
(function() {
    // 等待 DOM 完全加载
    if (document.readyState !== 'complete') {
        return null;
    }
    
    // 尝试从 iframe 获取
    var iframe = document.getElementById('iframeautoheight');
    if (iframe && iframe.contentWindow && iframe.contentWindow.document) {
        var iframeDoc = iframe.contentWindow.document;
        if (iframeDoc.readyState === 'complete') {
            return iframeDoc.body.innerHTML;
        }
    }
    
    // 返回整个页面
    return document.body.innerHTML;
})();
```

## 最佳实践

### 推荐的导入流程

```
第一步：准备
├─ 确保网络连接正常
├─ 准备好学号和密码
└─ 关闭其他可能干扰的程序

第二步：登录
├─ 启动应用
├─ 选择"从教务系统导入"
├─ 选择"南华大学"
├─ 等待登录页面加载
├─ 输入学号密码
└─ 点击登录按钮

第三步：导航
├─ 登录成功后等待跳转
├─ 在页面内点击"课表查询"
├─ 选择学期（如需要）
└─ 等待课表显示

第四步：提取
├─ 确认课表内容可见
├─ 等待"✓ 就绪"提示
├─ 点击"获取课表"按钮
└─ 确认导入结果
```

### 避免的操作

❌ **不要做**:
- 直接在地址栏输入课表 URL
- 在页面未加载完成时点击获取
- 频繁刷新或重复点击
- 同时打开多个导入窗口
- 在导入过程中切换学校

✅ **应该做**:
- 从登录页开始完整流程
- 等待每个页面完全加载
- 通过页面内链接导航
- 一次只导入一个学期
- 保持网络连接稳定

## 错误消息解读

### "提取失败 - 请检查登录状态"
**含义**: 无法获取页面内容  
**操作**: 刷新页面并重新登录

### "访问被拒绝 - 请重新登录"
**含义**: 检测到 403/404/500 错误  
**操作**: 重新登录，不要直接访问 URL

### "请导航到课表页面"
**含义**: 当前页面不是课表  
**操作**: 在浏览器内点击导航到课表

### "未找到课程"
**含义**: 页面中没有课程数据  
**操作**: 确认课表有内容，选择正确的学期

### "解析失败"
**含义**: HTML 格式不符合预期  
**操作**: 联系开发者，提供页面截图

## 调试技巧

### 查看页面源代码
```
1. 在 WebView 中右键
2. 选择"检查元素"（如果可用）
3. 查看 HTML 结构
4. 确认是否有 kbcontent 类
```

### 手动保存 HTML
```
1. 在课表页面右键
2. 选择"保存为"
3. 保存为 .html 文件
4. 使用"从 HTML 导入"功能测试
```

### 测试导入器
```bash
# 使用保存的 HTML 文件测试
python test_usc_real_html.py

# 输入文件路径进行测试
```

## 技术细节

### User-Agent 设置
```python
# 模拟 Chrome 120 浏览器
profile.setHttpUserAgent(
    "Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
    "AppleWebKit/537.36 (KHTML, like Gecko) "
    "Chrome/120.0.0.0 Safari/537.36"
)
```

### 页面加载监听
```python
# 监听加载进度
self.webview.loadProgress.connect(self._on_load_progress)

# 监听加载完成
self.webview.loadFinished.connect(self._on_load_finished)
```

### 按钮状态控制
```python
# 加载中：禁用按钮
self.import_btn.setEnabled(False)

# 加载完成：启用按钮
self.import_btn.setEnabled(True)
```

## 联系支持

如果以上方法都无法解决问题，请：

1. **收集信息**:
   - 错误消息截图
   - 页面 URL
   - 操作步骤
   - 系统环境

2. **提供 HTML 样本**:
   - 保存课表页面为 HTML
   - 删除个人信息
   - 提供给开发者

3. **提交 Issue**:
   - 描述问题
   - 附上截图
   - 说明已尝试的解决方案

## 更新日志

### 2025-12-31
- ✅ 添加 User-Agent 设置
- ✅ 添加页面加载进度监听
- ✅ 改进错误提示消息
- ✅ 添加登录状态检测
- ✅ 优化 JavaScript 提取逻辑
- ✅ 添加按钮状态控制

---

**提示**: 大多数问题都可以通过"重新登录"和"等待加载完成"解决！
